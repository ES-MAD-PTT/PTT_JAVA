<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  

<mapper namespace="com.atos.mapper.dam.ContractNomPointMapper">


	<select id="selectShippers" resultType="com.atos.beans.ComboFilterNS">
		SELECT tuser.idn_user_group as key, tuser.user_group_id as value
    	FROM tpa_tuser_group tuser
    	WHERE tuser.idn_user_group_type = (SELECT idn_user_group_type FROM tpa_tuser_group_type WHERE type_code = 'SHIPPER')
    </select>

    <resultMap type="com.atos.beans.dam.ContractNomPointBean" id="ContractNomPoint">
        <id column="idn_contract_nom_point" property="idn_contract_nom_point"  /> 
        <result property="idn_contract" column="idn_contract"/>
        <result property="idn_contract_point" column="idn_contract_point"/>
        <result property="idn_nomination_point" column="idn_nomination_point"/>
        <result property="contract_id" column="contract_id"/>
        <result property="startDate" column="start_date"/>   
        <result property="endDate" column="end_date"/>
        <result property="startDateActive" column="start_date_active"/>   
        <result property="endDateActive" column="end_date_active"/>  
       	<result property="contract_point" column="contract_point"/>
       	<result property="nomination_point" column="nomination_point"/>
       	<result property="shipper" column="shipper"/>
        <result property="idn_shipper" column="idn_shipper"/> 
    </resultMap>
     
    <select id="selectContractNomPoints" resultMap="ContractNomPoint">
    with cont_nom_point as (
select
	tcnp.idn_contract as idn_contract,
	u.user_group_id as shipper,
	u.idn_user_group as idn_shipper,
	tc.contract_code as contract_id,
	tc.start_date,
	tc.end_date,
	tcnp.active_date_from as start_date_active,
	tcnp.active_date_to as end_date_active
from
	tpa_tcontract_nom_point tcnp,
	tpa_tcontract tc,
	tpa_tuser_group u
where
	tcnp.idn_contract = tc.idn_contract
	and tc.idn_user_group = u.idn_user_group
	<if test = "idn_contract != null">
		and tcnp.idn_contract = #{idn_contract}
   	</if>  
   <if test = "startDate != null">
	and nvl(tcnp.active_date_to, to_date('9999/12/31', 'yyyy/mm/dd'))>= #{startDate}
    </if>
    <if test = "endDate != null">
	and #{endDate} >= tcnp.active_date_from
    </if> 
    <if test = "idn_shipper != null">
	and tc.idn_user_group = #{idn_shipper}
    </if> 

)
select
	*
from
	cont_nom_point tcnp
group by
	tcnp.idn_contract,
	tcnp.shipper,
	tcnp.idn_shipper,
	tcnp.contract_id,
	tcnp.start_date,
	tcnp.end_date ,
	tcnp.start_date_active,
	tcnp.end_date_active
order by
	tcnp.idn_contract,
	tcnp.start_date,
	tcnp.start_date_active
	</select>
	
	<select id="selectIdShipper" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	SELECT	
			u.IDN_USER_GROUP AS idn_shipper
		FROM	
			tpa_tuser_group u
		WHERE 
			u.USER_GROUP_id = #{shipper}
	</select>
	
	<select id="selectContraCodeById" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	SELECT
			c.contract_code as contract_id
		FROM
			tpa_tcontract c
		WHERE
			c.idn_contract = #{idn_contract}
	</select>
	
	<select id="selectCodeNomPointById" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	SELECT
			sp.point_code as nomination_point
		FROM
			tpa_vsystem_point sp
		WHERE
			sp.group_code = 'NOMINATION'
			AND sp.idn_system_point = #{idn_nomination_point}
	</select>
	
	<select id="selectContractNomPointsFormTable" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	select (select sp.idn_system_point from tpa_tsystem_point sp where sp.idn_system_point=#{idn_contract_point}) as idn_contract_point,
	       (select sp.point_code from tpa_tsystem_point sp where sp.idn_system_point=#{idn_contract_point}) as contract_point,
	       t1.idn_system_point as idn_nomination_point,
	       t1.point_code as nomination_point        
			from tpa_tsystem_point t1
			where t1.idn_system_point in
			       (select distinct idn_nomination_point
			          from TPA_TSYSTEM_POINT_PARAM t
			         where idn_contract_point = #{idn_contract_point})
			order by contract_point, nomination_point 
	</select>
	
	<select id="selectContractNomPointsFormEdit" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	SELECT
	tcnp.idn_contract_nom_point AS idn_contract_nom_point,
	tcnp.idn_contract AS idn_contract,
	(
	SELECT
		idn_system_point
	FROM
		tpa_tsystem_point
	WHERE
		idn_system_point IN (
		SELECT
			idn_contract_point
		FROM
			tpa_tsystem_point_param
		WHERE
			idn_nomination_point = tcnp.idn_nom_point and nvl(end_date, to_date('31/12/9999', 'DD/MM/YYYY')) >= start_date)) AS idn_contract_point,
	tcnp.idn_nom_point AS idn_nomination_point,
	(
	SELECT
		point_code
	FROM
		tpa_tsystem_point
	WHERE
		idn_system_point IN
        (
		SELECT
			idn_contract_point
		FROM
			tpa_tsystem_point_param
		WHERE
			idn_nomination_point = tcnp.idn_nom_point and nvl(end_date, to_date('31/12/9999', 'DD/MM/YYYY')) >= start_date)) AS contract_point,
	(
	SELECT
		t.point_desc
	FROM
		TPA_TSYSTEM_POINT t
	WHERE
		t.idn_system_point = tcnp.idn_nom_point and nvl(end_date, to_date('31/12/9999', 'DD/MM/YYYY')) >= start_date) AS nomination_point
FROM
	TPA_TCONTRACT_NOM_POINT tcnp,
	TPA_TCONTRACT tc
WHERE
	tcnp.idn_contract = tc.idn_contract
	AND tcnp.idn_contract = #{idn_contract}
	AND tcnp.active_date_from = #{startDateActive}
	AND tcnp.active_date_to = #{endDateActive}
ORDER BY
	contract_point, nomination_point asc

	</select>
	
	<select id="selectContractNomPointsNullFormTable" resultMap="ContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
    	with w_nom_point_all_contract_point as
      (select 
       t1.idn_system_point as idn_nom_point,
       t1.point_code as nom_point_code        
from tpa_tsystem_point t1
where t1.idn_system_point in
       (select distinct idn_nomination_point
          from TPA_TSYSTEM_POINT_PARAM t
         where idn_contract_point in(


select t1.idn_system_point as key
  from tpa_tsystem_point t1
where 1 = 1
  <if test="startDate != null">
   AND nvl(t1.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >= #{startDate}
   </if>
   <if test="endDate != null">
   AND #{endDate} >= t1.start_date
   </if>
   and t1.idn_system_point in
       (select idn_contract_point
          from tpa_tsystem_point_param t2
         where 1 = 1
          <if test="startDate != null">
           AND nvl(t2.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >= #{startDate}
           </if>
           <if test="endDate != null">
           AND #{endDate} >= t2.start_date
           </if>
           and idn_contract_point in
               (select distinct idn_system_point
                  from TPA_TCONTRACT_POINT t3
                 where 1 = 1
                and t3.idn_contract_agreement in
                       (select idn_contract_agreement
                          from tpa_tcontract_agreement t6
                         where 1 = 1
                        <if test="startDate != null">
                          AND nvl(t6.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=  #{startDate}
                          </if>
                          <if test="endDate != null">
                          AND #{endDate} >= t6.start_date
                          </if>
                          and t6.idn_contract_request in
                             (select idn_contract_request
                                from tpa_tcontract_request t4
                               where 1 = 1
                                <if test="startDate != null">
                                 AND nvl(t4.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=  #{startDate}
                                 </if>
                                 <if test="endDate != null">
                                 AND #{endDate} >= t4.start_date
                                 </if>
                                 and t4.idn_contract in
                                     (select idn_contract
                                        from tpa_tcontract t5
                                       where 1 = 1
                                        <if test="startDate != null">
                                         AND nvl(t5.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=#{startDate}
                                         </if>
                                         <if test="endDate != null">
                                         AND #{endDate} >= t5.start_date
                                         </if>
                                         and t5.idn_contract = #{idn_contract}
                                         and t5.idn_pipeline_system = #{idn_system}
                                      )
                              )
                          )
                 )
         ))))
         
 
select p.idn_contract_point idn_contract_point, sp.point_code as contract_point, w.idn_nom_point as idn_nomination_point, w.nom_point_code as nomination_point
from tpa_tsystem_point sp,
     Tpa_Tsystem_Point_Param p,
     w_nom_point_all_contract_point w
where p.idn_nomination_point = w.idn_nom_point
  and sp.idn_system_point = p.idn_contract_point
group by  p.idn_contract_point,sp.point_code ,w.idn_nom_point, w.nom_point_code
order by contract_point, nomination_point asc

	</select>

     <select id="selectContractIds" resultType="com.atos.beans.ComboFilterNS">

		select t.idn_contract as key,
	       t.CONTRACT_code as value
 		from TPA_TCONTRACT t
		where 1 = 1
		<if test="idn_shipper != null and idn_shipper != ''"> 
			and t.idn_user_group = #{idn_shipper}
		</if>
		and t.idn_pipeline_system = #{idn_system}
		   <if test="startDate != null">
		    AND nvl(t.end_date,to_date('9999/12/31','yyyy/mm/dd'))>=  #{startDate}
		    </if>
		    <if test="startDate == null">
		    and 1=0
		    </if>
		    <if test="endDate != null">
		      AND #{endDate} >= t.start_date
		    </if> 
		    <if test="endDate == null">
		    and 1=0
		    </if>
	</select>

     <select id="selectContractForm" resultType="com.atos.beans.ComboFilterNS">
		SELECT
			t.idn_contract AS KEY,
			t.CONTRACT_code AS value
		FROM
			TPA_TCONTRACT t,
			TPA_TUSER_GROUP u
		WHERE
			1 = 1
			AND t.idn_user_group = u.idn_user_group
			AND t.idn_user_group = #{idn_shipper} 
		<if test = "startDate != null">
			AND nvl(t.end_date, to_date('9999/12/31', 'yyyy/mm/dd'))>= #{startDate}
		</if>		
		<if test = "endDate != null">
			AND #{endDate} >= t.start_date
		</if>
	</select>

     <select id="selectContractNomPointsForm" resultType="com.atos.beans.ComboFilterNS">

select t1.idn_system_point as key, t1.point_code as value
  from tpa_tsystem_point t1
 where 1 = 1
   <if test="startDate != null">
   AND nvl(t1.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >= #{startDate}
   </if>
   <if test="endDate != null">
   AND #{endDate} >= t1.start_date
   </if> 
   and t1.idn_system_point in
       (select idn_contract_point
          from tpa_tsystem_point_param t2
         where 1 = 1
          <if test="startDate != null">
           AND nvl(t2.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >= #{startDate}
		       </if>
           <if test="endDate != null">
           AND #{endDate} >= t2.start_date
           </if> 
           and idn_contract_point in
               (select distinct idn_system_point
                  from TPA_TCONTRACT_POINT t3
                 where 1 = 1
                and t3.idn_contract_agreement in
                       (select idn_contract_agreement
                          from tpa_tcontract_agreement t6
                         where 1 = 1
                         <if test="startDate != null">
                          AND nvl(t6.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=  #{startDate}
		                      </if>
                          <if test="endDate != null">
                          AND #{endDate} >= t6.start_date
                          </if> 
                          and t6.idn_contract_request in
                             (select idn_contract_request
                                from tpa_tcontract_request t4
                               where 1 = 1
                                <if test="startDate != null">
                                 AND nvl(t4.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=  #{startDate}
		                             </if>
                                 <if test="endDate != null">
                                 AND #{endDate} >= t4.start_date
                                 </if> 
                                 and t4.idn_contract in
                                     (select idn_contract --idn_contract_request
                                        from tpa_tcontract t5
                                       where 1 = 1
                                        <if test="startDate != null">
                                         AND nvl(t5.end_date, to_date('9999/12/31', 'yyyy/mm/dd')) >=#{startDate}
                                         </if>
                                         <if test="endDate != null">
                                         AND #{endDate} >= t5.start_date
                                         </if> 
                                         and t5.idn_contract = #{idn_contract}
                                         and t5.idn_pipeline_system = #{idn_system}
                                      )
                              )
                          )
                 )
         )
 ORDER BY t1.point_code
	</select>


     <select id="selectNominationPointsForm" resultType="com.atos.beans.ComboFilterNS">
select t1.idn_system_point as key,
       t1.point_code as value
  from tpa_tsystem_point t1
 where t1.idn_system_point in
       (select distinct idn_nomination_point
          from TPA_TSYSTEM_POINT_PARAM t
         where idn_contract_point = #{idn_contract_point})
	</select>


     <select id="selectContractPoints" resultType="com.atos.beans.ComboFilterNS">
		  select t1.idn_system_point as key,
       t1.point_code as value
  from tpa_tsystem_point t1
 where 1=1
       <if test="startDate != null">
		    AND nvl(t1.end_date,to_date('9999/12/31','yyyy/mm/dd'))>=  #{startDate}
		    </if>
        <if test="endDate != null">
		      AND #{endDate} >= t1.start_date
		    </if> 
  and t1.idn_system_point in
       (select idn_contract_point
          from tpa_tsystem_point_param t2
         where 1=1
       <if test="startDate != null">
		    AND nvl(t2.end_date,to_date('9999/12/31','yyyy/mm/dd'))>=  #{startDate}
		    </if>
        <if test="endDate != null">
		      AND #{endDate} >= t2.start_date
		    </if> 
  and idn_contract_point in
               (select distinct idn_system_point
                  from TPA_TCONTRACT_POINT t3
                 where 1=1
  and t3.idn_contract_agreement in
                       (select idn_contract_agreement
                          from tpa_tcontract_request t4
                         where 1=1
       <if test="startDate != null">
		    AND nvl(t4.end_date,to_date('9999/12/31','yyyy/mm/dd'))>=  #{startDate}
		    </if>
        <if test="endDate != null">
		      AND #{endDate} >= t4.start_date
		    </if> 
  and t4.idn_contract_request in
                               (select idn_contract_request
                                  from tpa_tcontract t5
                                 where 1=1
       <if test="startDate != null">
		    AND nvl(t5.end_date,to_date('9999/12/31','yyyy/mm/dd'))>=  #{startDate}
		    </if>
        <if test="endDate != null">
		      AND #{endDate} >= t5.start_date
		    </if> 
  and t5.idn_contract = #{idn_contract}
                                   and t5.idn_pipeline_system = #{idn_system}))))

		 ORDER BY  t1.point_code
    </select>
  

	<select id="selectNominationPoints" resultType="com.atos.beans.ComboFilterNS">
select t1.idn_system_point as key,
       t1.point_code as value
  from tpa_tsystem_point t1
 where t1.idn_system_point in
       (select distinct idn_nomination_point
          from TPA_TSYSTEM_POINT_PARAM t
         where idn_contract_point = #{idn_contract_point})
order by t1.point_code
	</select>
	
	<select id="selectExistingNumSlop" resultType="java.math.BigDecimal" parameterType="com.atos.beans.dam.ContractNomPointBean">
		SELECT
			count(*)
		FROM
			TPA_TCONTRACT_NOM_POINT t
		WHERE
			t.idn_contract = #{idn_contract}
			<if test="lisIdnNominationPoint != null and !lisIdnNominationPoint.isEmpty()">
			  	and t.idn_nom_point in
			  	<foreach collection="lisIdnNominationPoint" item="item" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			AND (#{startDate} BETWEEN t.active_date_from AND t.active_date_to
				OR #{endDate} BETWEEN t.active_date_from AND t.active_date_to)
	</select>
	
	<select id="selectDateContra" resultType="java.util.Date" parameterType="com.atos.beans.dam.ContractNomPointBean">
		select
			c.end_date
		from
			tpa_tcontract c
		where
			c.idn_contract = #{idn_contract}    
		<if test = "endDate != null">
			and #{endDate} <![CDATA[<=]]> c.end_date
		</if>
	</select>
 
	<insert id="insertContractNomPoint" useGeneratedKeys="true" keyProperty="idn_contract_nom_point" keyColumn="idn_contract_nom_point" parameterType="com.atos.beans.dam.ContractNomPointBean">
		insert into tpa_tcontract_nom_point
			(idn_contract_nom_point,idn_contract,idn_nom_point,active_date_from, active_date_to,
			 aud_ins_user,aud_last_user)
		values
			(tpa_scontract_nom_point.nextval,
			 #{idn_contract},
			 #{idn_nomination_point},
			 #{startDate},
			 #{endDate},
		     #{username},
			 #{username})
	</insert>
	
	<update id="updateContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
		UPDATE TPA_TCONTRACT_NOM_POINT set
			IDN_NOM_POINT = #{idn_nomination_point},
			aud_last_user = #{username}
		WHERE idn_contract_nom_point = #{idn_contract_nom_point}
	</update>
	 	
	<select id="getContractNomPointCode" resultType="java.math.BigDecimal" parameterType="com.atos.beans.dam.ContractNomPointBean">
	    SELECT t.IDN_CONTRACT_NOM_POINT
    FROM TPA_TCONTRACT_NOM_POINT t
    WHERE t.IDN_CONTRACT = #{idn_contract}
          AND  t.IDN_NOM_POINT = #{idn_nomination_point}
          AND  t.active_date_from = #{startDate}
          AND  t.active_date_to = #{endDate}      
	</select>
	
	<select id="getIdnSystemPoint" resultType="java.math.BigDecimal" parameterType="com.atos.beans.dam.ContractNomPointBean">
	    SELECT
			idn_system_point
		FROM
			tpa_tsystem_point
		WHERE
			idn_system_point IN (
			SELECT
				idn_contract_point
			FROM
				tpa_tsystem_point_param
			WHERE
				idn_nomination_point = #{idn_nomination_point})     
	</select>
	
	<delete id="deleteContractNomPoint" parameterType="com.atos.beans.dam.ContractNomPointBean">
   		DELETE TPA_TCONTRACT_NOM_POINT tnp WHERE tnp.idn_contract_nom_point = #{idn_contract_nom_point}
   	</delete>	
</mapper>