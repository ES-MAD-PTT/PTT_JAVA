<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.atos.mapper.forecasting.QueryShipperForecastingMapper">
 
     <select id="selectShipper" parameterType="com.atos.filters.forecasting.QueryShipperForecastingFileFilter" resultType="com.atos.beans.ComboFilterNS">
		SELECT a.idn_user_group as key, a.short_name as value
		  FROM tpa_tuser_group a,
		       tpa_tuser_group_type b,
		       (SELECT ugt.type_code,
		               ug.idn_user_group
		          FROM tpa_tuser            u,
		               tpa_tuser_group      ug,
		               tpa_tuser_group_type ugt
		         WHERE u.user_id = #{user}
		           AND u.idn_user_group = ug.idn_user_group
		           AND ug.idn_user_group_type = ugt.idn_user_group_type) c
		 WHERE a.idn_user_group_type = b.idn_user_group_type
		   AND b.type_code = 'SHIPPER'
		   AND ((c.type_code = 'SHIPPER' AND c.idn_user_group = a.idn_user_group) OR c.type_code = 'OPERATOR')
		order by UPPER(value)

    </select>

     <select id="selectTermCode" resultType="com.atos.beans.ComboFilterNS">		
		SELECT DISTINCT o.IDN_OPERATION_TERM as key, o.TERM_CODE as value 
		FROM tpa_voperation o 
		WHERE o.CATEGORY_CODE = 'FORECASTING'
		order by o.IDN_OPERATION_TERM
    </select>

	<select id="selectGetFile" parameterType="java.util.TreeMap" resultType="com.atos.beans.forecasting.OperationFileBean">
		select idn_operation_file,
	       idn_operation_category,
	       idn_operation_term,
	       file_name,
	       version_date,
	       binary_data
	    from tpa_toperation_file o
		where o.idn_operation_file = #{idn_operation_file}
	</select>
	
	<select id="selectQueryForecasting" parameterType="com.atos.filters.forecasting.QueryShipperForecastingFileFilter" resultType="com.atos.beans.forecasting.QueryShipperForecastingFileBean">
	SELECT f.idn_forecasting,
	   f.forecasting_code,
       f.idn_operation,
       f.idn_user_group,
       ug.user_group_id,
       ug.short_name,
       f.start_date,
       f.end_date,
       f.idn_shipper_file,
       o.term_code,
       (SELECT file_name FROM tpa_toperation_file WHERE f.idn_shipper_file = idn_operation_file) AS shipper_file_name,
       (SELECT version_date FROM tpa_toperation_file WHERE f.idn_shipper_file = idn_operation_file) AS shipper_file_date,
       f.idn_operator_file,
	   (SELECT file_name FROM tpa_toperation_file WHERE f.idn_operator_file = idn_operation_file) AS operator_file_name,
	   (SELECT version_date FROM tpa_toperation_file WHERE f.idn_operator_file = idn_operation_file) AS operator_file_date 
 	 FROM 	tpa_tforecasting f,
       		tpa_tuser_group  ug,
       		tpa_voperation   o
 	WHERE f.idn_pipeline_system =  #{idn_system} <!-- offshore -->
        AND f.idn_user_group = ug.idn_user_group
  		AND f.idn_operation = o.idn_operation
 	 	AND o.category_code = #{category_code}
	<if test="forecasting_code != null and forecasting_code != ''">
		and f.forecasting_code like #{forecasting_code}
	</if>
	<if test="term_code != null and term_code != ''">
		AND o.term_code =  #{term_code}
	</if> 
   	<if test="shipper_code != null and shipper_code != ''">
 		and ug.idn_user_group = #{shipper_code}
  	</if> 
	   AND f.end_date   >= #{start_date}
	   AND #{end_date} >= f.start_date 
	   AND f.version_date = (SELECT MAX(fx.version_date)
	                           FROM tpa_tforecasting fx
	                          WHERE f.idn_operation = fx.idn_operation
	                            AND f.idn_user_group = fx.idn_user_group
	                            AND f.start_date = fx.start_date
	                            AND f.end_date = fx.end_date
                                   AND f.idn_pipeline_system = fx.idn_pipeline_system)
 		ORDER BY ug.user_group_id
  	</select>

	
</mapper>
