<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.atos.mapper.dam.ModeZoneBaseInvMapper">


	<resultMap type="com.atos.beans.dam.ModeZoneBaseInvBean" id="ModeZoneBaseInv">
		<id column="idn_base_inv_setup" property="id" />
		<result property="idn_pipeline_system" column="idn_pipeline_system" />
		<result property="idn_zone" column="idn_zone" />
		<result property="idn_mode" column="idn_base_inv_mode" />
		<result property="mode" column="mode_code" />
		<result property="idn_system" column="pipeline_system_code" />
		<result property="zone" column="zone_code" />
		<result property="startDate" column="start_date" />
		<result property="username" column="aud_ins_user" />
		<result property="username" column="aud_last_user" />

	</resultMap>

	<select id="selectModeZoneBaseInv" resultMap="ModeZoneBaseInv">
		SELECT z.idn_base_inv_setup, z.start_date, z.IDN_ZONE, zo.zone_code, z.idn_base_inv_mode, im.mode_code
		FROM TPA_TBASE_INV_SETUP  z, TPA_TZONE zo, TPA_TBASE_INV_MODE im
		WHERE z.VERSION_DATE = (select max(zx.version_date )
		                          from TPA_TBASE_INV_SETUP zx
		                          where z.start_date = zx.start_date
		                          and z.idn_base_inv_mode = zx.idn_base_inv_mode
		                          and z.idn_zone = zx.idn_zone)
		AND z.idn_zone = zo.idn_zone
		AND z.idn_base_inv_mode = im.idn_base_inv_mode 


	   <if test="idn_zone != null and idn_zone != ''">
			AND z.idn_zone = #{idn_zone}
	   </if>
	   <if test="idn_mode != null and idn_mode != ''">
			AND z.idn_base_inv_mode= #{idn_mode} 
	   </if>
	   <if test="startDate != null">
			AND z.start_date >= #{startDate}
	   </if>
   
	</select>

	<select id="selectZonesSystem" resultType="com.atos.beans.ComboFilterNS">
		SELECT DISTINCT z.idn_zone as key, z.zone_code as value 
		FROM TPA_TZONE z, TPA_TBASE_INV_MODE_ZONE mz 
		WHERE z.IDN_ZONE = mz.IDN_ZONE 
		AND TRUNC(SYSDATE) between mz.START_DATE AND NVL(mz.END_DATE, to_date('9999-12-31','yyyy-mm-dd'))
		AND Z.IDN_PIPELINE_SYSTEM = #{idn_system}
		order by 1
	</select>
	
	<select id="selectModesSystem" resultType="com.atos.beans.ComboFilterNS">
		select im.idn_base_inv_mode as key, im.mode_code as value
		from TPA_TBASE_INV_MODE im, TPA_TBASE_INV_MODE_zone imz, TPA_TZONE z
		where im.idn_base_inv_mode = imz.idn_base_inv_mode
		AND imz.idn_zone = z.idn_zone
		AND z.idn_zone = #{idn_zone}
	</select>

	<insert id="insertModeZoneBaseInv" useGeneratedKeys="true" keyProperty="Idn_Base_Inv_Setup"
		keyColumn="Idn_Base_Inv_Setup" parameterType="com.atos.beans.dam.ModeZoneBaseInvBean">
		INSERT INTO TPA_TBASE_INV_SETUP 
		(Idn_Base_Inv_Setup, 
		Idn_Zone, 
		IDN_BASE_INV_MODE, 
		Start_Date,
		aud_ins_user,aud_last_user)
		VALUES 
		(tpa_sbase_inv_setup.nextval, 
		#{idn_zone}, 
		#{idn_mode}, 
		#{startDate},
    	#{username},
        #{username})
	</insert>

	<update id="updateModeZoneBaseInv" parameterType="com.atos.beans.dam.ModeZoneBaseInvBean">
		UPDATE TPA_TBASE_INV_SETUP BIS
		SET BIS.IDN_BASE_INV_MODE = #{idn_mode},
      	aud_last_user = #{username}
		WHERE IDN_BASE_INV_SETUP = #{id} 
		AND BIS.start_date >= trunc(SYSDATE)
	</update>

</mapper>