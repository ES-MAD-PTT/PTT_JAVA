<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:shiro="http://shiro.apache.org/tags"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:f="http://java.sun.com/jsf/core"	
	template="/templates/template.xhtml">
	
	<ui:define name="metadata">
	</ui:define>
	<ui:define name="breadCrumbComponent">
		<p:breadCrumb id="path_page" style="margin-bottom:3px">
			<p:menuitem value="#{msg['menu_home']}" icon="ui-icon fa fa-home" style="bottom: -3px;left: 3px" url="/home.xhtml" />
			<p:menuitem value="#{msg['menu_booking']}" url="#" />
			<p:menuitem value="#{msg['menu_cr_query']}" url="/pages/booking/CapacityRequestQuery.xhtml" />
		</p:breadCrumb>
	</ui:define>
	<ui:define name="content">
				
		<h:form id="form" style="width:100%;height:98%;border-collapse:collapse" fullPage="true">
			<p:growl id="msgs" showDetail="true" life="10000"/>
			
            <p:layout widgetVar="CRQueryLayout" style="width:100%;height:100%" showEffect="clip"  hideEffect="clip">
				
				<p:layoutUnit position="north" resizable="false" closable="false"
					collapsible="true" id="page_filters">	
					
				<p:panelGrid columns="2" style="width:100%">
					
						<p:panelGrid>
							<p:row>
								<p:column  style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_capacity_request_code']}" />
								</p:column>
								<p:column  style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_shipper_id']}" />
								</p:column>
								<p:column  style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_contract_type']}" />
								</p:column>
								<p:column  style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_status']}" />
								</p:column>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_submitted_from']}" />
								</p:column>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['cr_man_submitted_to']}" />
								</p:column>
							</p:row>
							<p:row>
								<p:column style="width:120px">
									<p:inputText id="capacityRequestCode" style="width:150px" value="#{CRQueryView.filters.capacityRequestCode}" />
								</p:column>
								<p:column>
									<p:selectOneMenu id="shipperId" style="width:120px" value="#{CRQueryView.filters.shipperId}" 
										rendered="#{!CRQueryView.isShipper()}">
										   		<f:selectItem itemLabel="#{CRQueryView.filters.shipperCode}" itemValue="#{CRQueryView.filters.shipperId}" />
        										<f:selectItems value="#{CRQueryView.shipperIds.entrySet()}" var="entry" 
        											itemValue="#{entry.key}" itemLabel="#{entry.value}" />
					           		</p:selectOneMenu>
									<h:outputText value="#{CRQueryView.user.user_group_id}" style="float:left" rendered="#{CRQueryView.isShipper()}"/>	
								</p:column>

								<p:column>
									<p:selectCheckboxMenu id="contractType" autoWidth="false" style="width:180px" 
										value="#{CRQueryView.filters.contractTypeId}" label="#{msg['cr_man_contract_type']}" >
      									<f:selectItems value="#{CRQueryView.contractTypes.entrySet()}" var="entry" 
      										itemValue="#{entry.key}" itemLabel="#{entry.value}" />
					           		</p:selectCheckboxMenu>								
								</p:column>

								<p:column>
									<p:selectCheckboxMenu id="status" autoWidth="false" style="width:75px" value="#{CRQueryView.filters.status}" 
										label="#{msg['cr_man_status']}" >
								   		<f:selectItem itemLabel="#{msg['cr_man_submitted']}" itemValue="SUBMITTED" />
								   		<f:selectItem itemLabel="#{msg['cr_man_accepted']}" itemValue="ACCEPTED" />
								   		<f:selectItem itemLabel="#{msg['cr_man_completed']}" itemValue="COMPLETED" />
								   		<f:selectItem itemLabel="#{msg['cr_man_rejected']}" itemValue="PTT_REJECTED" />
					           		</p:selectCheckboxMenu>							
								</p:column>
								
								<p:column>
									<p:calendar id="fecInicio" size="6" pattern="dd/MM/yyyy" mask="true" value="#{CRQueryView.filters.startDate}"
										showOn="button" navigator="true">
										<p:ajax event="dateSelect" update="fecInicio"></p:ajax>
										<p:ajax event="change" update="fecInicio"></p:ajax>
									</p:calendar>
								</p:column>
								<p:column>
									<p:calendar id="fecFin" size="6" pattern="dd/MM/yyyy" mask="true" value="#{CRQueryView.filters.endDate}"
										showOn="button" navigator="true">
										<p:ajax event="dateSelect" update="fecFin"></p:ajax>
										<p:ajax event="change" update="fecFin"></p:ajax>
									</p:calendar>
								</p:column>
							
								
							</p:row>
						</p:panelGrid>
						<p:panelGrid columns="2" style="float:right;top:0px">
							<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.QUERY">									
								<p:commandButton value="#{msg['search']}" icon="ui-icon fa fa-search" 
									actionListener="#{CRQueryView.onSearch}"
									onstart="PF('cargando').show()"
									oncomplete="PF('cargando').hide()" 
									update="msgs,:#{p:component('capRequests1')}"/>
							</shiro:hasPermission>
									
							<p:commandButton  onclick="PF('CRQueryLayout').toggle('north')" id="header_collapse" icon="fa fa-minus" 
									value="#{msg['minimize']}" title="#{msg['collapse_header']}" />

							<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.QUERY">
								 <p:commandButton value="#{msg['clear']}"
									actionListener="#{CRQueryView.onClear}"
									onstart="PF('limpiando').show()"
									oncomplete="PF('limpiando').hide()" 
									process="@this"
									update="msgs,@form"/>
							</shiro:hasPermission>
						</p:panelGrid>
					</p:panelGrid>

				</p:layoutUnit>

				<p:layoutUnit id="table_center_layout" position="center" resizable="false" closable="false" collapsible="false" style="border: 0;">

					<p:dataTable widgetVar="w_capRequests1"  id="capRequests1" var="capRequest" value="#{CRQueryView.items}"
						selectionMode="single" selection="#{CRQueryView.selected}" rowKey="#{capRequest.id}" 
						reflow="true" style="margin-bottom:20px;border-collapse:collapse"
						scrollable="true" scrollHeight="100%"
					    paginator="true" rows="15" rowsPerPageTemplate="5,10,15,20,25, #{CRQueryView.itemsSize}" >
						<f:facet name="header"> 
								<p:outputPanel style="height:25px">
									<p:commandButton id="toggler" type="button" value="Columns" style="float:right" icon="ui-icon-calculator" />
									<p:columnToggler datasource="capRequests1" trigger="toggler" style="width:200px"/>
								</p:outputPanel>        										          
	 				        </f:facet>
					       <p:column headerText="#{msg['cr_man_capacity_request_code']}" style="width: 130px;" sortBy="#{capRequest.id}">
					       <ui:remove>
					       		<h:outputText value="#{capRequest.requestCode}" style="float:right" />
							</ui:remove>
					       	<p:commandLink  actionListener="#{CRQueryView.linkAction}" ajax="true">
					       		<h:outputText value="#{capRequest.requestCode}" style="float:right" />
					       		<f:attribute name="request_code" value="#{capRequest.requestCode}"/>
					       		<f:attribute name="contract_type" value="#{capRequest.contractTypeCode}"/>
					       		<f:attribute name="shipper_name" value="#{capRequest.shipperCode}"/>
					       		</p:commandLink>
					       </p:column>

					       <p:column headerText="#{msg['cr_man_submitted_timestamp']}" style="width: 75px;" sortBy="#{capRequest.submittedTimestamp}">
			               		<h:outputText value="#{capRequest.submittedTimestamp}" >
			              				<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
			              		</h:outputText>
					       </p:column>

					       <p:column headerText="#{msg['cr_man_shipper_id']}" style="width: 100px;" sortBy="#{capRequest.shipperCode}">
					       		<h:outputText value="#{capRequest.shipperCode}" />
					       </p:column>

					       <p:column headerText="#{msg['cr_man_contract_type']}" style="width: 100px;" sortBy="#{capRequest.contractTypeCode}">
					       		<h:outputText value="#{capRequest.contractTypeCode}" />
					       </p:column>

					       <p:column headerText="#{msg['cr_man_contract_id']}" style="width: 140px;" sortBy="#{capRequest.contractCode}">
					       		<h:outputText value="#{capRequest.contractCode}" />
					       </p:column>

					       <p:column headerText="#{msg['cr_man_status']}" style="width: 65px; text-align: center" sortBy="#{capRequest.status}">
					       		<h:outputText value="#{CRQueryView.getStatusExternalCode(capRequest.status)}" />
					       </p:column>

					       <p:column headerText="#{msg['cr_man_contract_startdate']}" style="width: 70px;" sortBy="#{capRequest.contractStartDate}">
			               		<h:outputText value="#{capRequest.contractStartDate}" >
			              				<f:convertDateTime pattern="dd/MM/yyyy" />
			              		</h:outputText>
					       </p:column>
					       
					       <p:column headerText="#{msg['cr_man_contract_enddate']}" style="width: 70px;" sortBy="#{capRequest.contractEndDate}">
			               		<h:outputText value="#{capRequest.contractEndDate}" >
			              				<f:convertDateTime pattern="dd/MM/yyyy" />
			              		</h:outputText>
					       </p:column>

							<p:column headerText="#{msg['cr_man_xlsFile']}" style="width: 150px;" sortBy="#{capRequest.xlsFileName}">
							    <p:commandButton ajax="false" actionListener="#{CRQueryView.getFile(capRequest)}" 
							    	oncomplete="PrimeFaces.monitorDownload(start, stop);" icon="ui-icon fa fa-save" title="#{capRequest.xlsFileName}" >
									<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
							        <p:fileDownload value="#{CRQueryView.selected.xlsFile}"/>
							    </p:commandButton>
								<h:outputText value="#{capRequest.xlsFileName}" title="#{capRequest.xlsFileName}" />
					       </p:column>
					       
					       <!-- Cambio temporal 20210810 a peticion de supachai, se muestra solo si no es shipper -->
					       <p:column rendered="#{!CRQueryView.isShipper()}" headerText="#{msg['cr_man_submission_comments']}" style="width: 80px;" sortBy="#{capRequest.submissionComments}">
  					       		<p:commandButton value="#{msg['cr_man_details']}" onclick="PF('submissionCommentsDlg').show()" update=":subCommentsFormId" 
  					       			rendered="#{not empty capRequest.submissionComments}">
									<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
								</p:commandButton>							
					       </p:column>
						   <!-- se añade funcioanlidad si es shipper se cambia el action se pone el mismo que el boton save del popup -->
					       <p:column rendered="#{CRQueryView.isShipper()}"  headerText="#{CRQueryView.deleteReject()}" style="width: 120px;">
	        					<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
								    <p:splitButton value="#{msg['cr_man_feasibility']}" rendered="#{capRequest.status=='SUBMITTED' and CRQueryView.isReadyForFeasibility(capRequest)}">
								    	<p:menuitem value="#{CRQueryView.rejectButtonLabel}" 
								    		 action="#{CRQueryView.onRejectTechCapacityRequest}" 
								    		 update=":#{p:component('capRequests1')}">
											<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
										</p:menuitem>
								    </p:splitButton>								    								    
	        					</shiro:hasPermission>
					       </p:column>
					      <!-- Se queda como esta -->
					       <p:column rendered="#{!CRQueryView.isShipper()}"   headerText="#{msg['cr_man_reject']}" style="width: 120px;">
	        					<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
								    <p:splitButton value="#{msg['cr_man_feasibility']}" rendered="#{capRequest.status=='SUBMITTED' and CRQueryView.isReadyForFeasibility(capRequest)}">
								    	<p:menuitem value="#{CRQueryView.rejectButtonLabel}" action="#{CRQueryView.selectRequestedPoints(capRequest)}"
								    		oncomplete="PF('rejectTechDlg').show()" update=":#{p:component('rejectTechPanelGridId')}">
											<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
										</p:menuitem>
								    </p:splitButton>								    								    
	        					</shiro:hasPermission>
					       </p:column>

					       <p:column headerText="#{msg['cr_man_additional_docs']}" style="width: 70px; text-align: center;">
  					       		<p:commandButton icon="ui-icon-document" action="#{CRQueryView.selectAdditionalDocs(capRequest)}" update=":additionalDocsFormId"
									onstart="PF('cargando').show()"	oncomplete="PF('cargando').hide(),PF('additionalDocsDlg').show()" >
									<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
								</p:commandButton>
					       </p:column>

					       <p:column headerText="#{msg['cr_man_rejected_points']}" style="width: 80px;">
								<!-- Solo se muestra el boto de puntos rechazados en caso de que la CR haya sido rechazada por el operador. 
					       		Si hubiera sido rechazada por el shipper, ni siquiera aparece en la consulta.
					       		Ademas solo se muestra el boton en caso de rechazo tecnico del operador (cuando no se ha generado contrato todavia)
					       		porque solo en la ventan de rechazo tecnico se especifican puntos rechazados. -->
  					       		<p:commandButton value="#{msg['cr_man_details']}" action="#{CRQueryView.selectRejectedPoints(capRequest)}" update=":rejPointsFormId" 
  					       			oncomplete="PF('rejectPointsDlg').show()" rendered="#{capRequest.status=='PTT_REJECTED' and empty capRequest.contractId}">
									<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
								</p:commandButton>	
					       </p:column>

					       <p:column headerText="#{msg['cr_man_management_comments']}" style="width: 80px;" sortBy="#{capRequest.managementComments}">
  					       		<p:commandButton value="#{msg['cr_man_details']}" onclick="PF('managementCommentsDlg').show()" update=":manCommentsFormId" 
  					       			rendered="#{not empty capRequest.managementComments}">
									<f:setPropertyActionListener value="#{capRequest}" target="#{CRQueryView.selected}" />
								</p:commandButton>							
					       </p:column>
					       
							<!-- Se hace render cuando la Capacity Request tiene contrato, es decir, cuando ha pasado por Accept. Podria luego estar REJECTED. -->
					       <p:column headerText="#{msg['cr_man_shadow_time']}" style="width: 100px;" sortBy="#{capRequest.shadowTime}">
					       		<h:outputText value="#{capRequest.shadowTime}" style="float:right" rendered="#{not empty capRequest.contractId}" >
			               			<f:convertNumber groupingUsed="true" minFractionDigits="3" maxFractionDigits="3" />
			               		</h:outputText>
					       </p:column>

							<!-- Se hace render cuando la Capacity Request tiene contrato, es decir, cuando ha pasado por Accept. Podria luego estar REJECTED. -->
					       <p:column headerText="#{msg['cr_man_shadow_period']}" style="width: 100px;" sortBy="#{capRequest.shadowPeriod}">
					       		<h:outputText value="#{capRequest.shadowPeriod}" style="float:right" rendered="#{not empty capRequest.contractId}" >
			               			<f:convertNumber groupingUsed="true" minFractionDigits="3" maxFractionDigits="3" />
			               		</h:outputText>
					       </p:column>

					       <p:column headerText="#{msg['cr_man_acept_timestamp']}" style="width: 100px;" sortBy="#{capRequest.acceptanceTimestamp}">
			               		<h:outputText value="#{capRequest.acceptanceTimestamp}" >
			              				<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
			              		</h:outputText>
					       </p:column>
					   </p:dataTable>
				</p:layoutUnit>
			</p:layout>
		</h:form> 

	<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">				
		<p:dialog header="#{msg['cr_man_reject_dialog_header']}" widgetVar="rejectTechDlg" modal="true" appendTo="@(body)" minHeight="250">
			<h:form id="rejectTechFormId" style="width:100%;height:98%;border-collapse:collapse">
				<p:growl id="msgs" showDetail="true" life="10000"/>
				<p:panelGrid id="rejectTechPanelGridId" columns="2">
					<p:panelGrid>
						<p:row>
							<p:column  style="font-weight: bold;">
								<h:outputText value="#{msg['cr_man_shipper_id']}:" />
							</p:column>
							<p:column>
								<h:outputText value="#{CRQueryView.selected.shipperCode}" />
							</p:column>
						</p:row>
						<p:row>
							<p:column  style="font-weight: bold;">
								<h:outputText value="#{msg['cr_man_submissionDate']}:" />
							</p:column>
							<p:column>
								<h:outputText value="#{CRQueryView.selected.submittedTimestamp}">
									<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
								</h:outputText>
							</p:column>
						</p:row>
						<p:row>
							<p:column  style="font-weight: bold;" colspan="2">
								<h:outputText value="#{msg['cr_man_select_contrated_points']}" />
							</p:column>
						</p:row>
						<p:row>
							<p:column colspan="2">
   								<p:pickList id="rejectedPointsPicklist" value="#{CRQueryView.selected.dualListPointCodes}" 
   									var="pointCodes" itemLabel="#{pointCodes}" itemValue="#{pointCodes}" />   									
							</p:column>
						</p:row>
					</p:panelGrid>
					<p:panelGrid id="rejectPanelGridRightId" columns="1">
						<h:outputText value="#{msg['cr_man_comments_remarks']}" />
 						<p:inputTextarea id="inputTxtCommentsRemarks" rows="12" cols="33" value="#{CRQueryView.selected.managementComments}" 
 							autoResize="false" maxlength="250">
 							<f:validateLength maximum="250" />
						</p:inputTextarea>
						<p:message for="inputTxtCommentsRemarks" />
						<p:commandButton value="#{msg['save']}" validateClient="true"
							actionListener="#{CRQueryView.onRejectTechCapacityRequest}" 
			       			update="#{p:component('capRequests1')},rejectTechFormId"
			       			oncomplete="PF('rejectTechDlg').hide()"/>
					</p:panelGrid>	
				</p:panelGrid>
			</h:form> 
		</p:dialog> 
	</shiro:hasPermission>

		<p:dialog header="#{msg['cr_man_submission_comments']}" widgetVar="submissionCommentsDlg" modal="true" appendTo="@(body)" height="200" width="800">
			<h:form id="subCommentsFormId" style="width:100%;height:98%;border-collapse:collapse">
  				<h:inputTextarea value="#{CRQueryView.selected.submissionComments}" readonly="true" rows="12" cols="105" style="border-color: white"/>
			</h:form> 
		</p:dialog>				

		<p:dialog header="#{msg['cr_man_additional_docs']}" widgetVar="additionalDocsDlg" modal="true" appendTo="@(body)" height="300" width="900" >
			<h:form id="additionalDocsFormId" style="width:100%;height:98%;border-collapse:collapse">
				<p:dataTable widgetVar="w_additionalDocsTable1"  id="additionalDocs1" 
					value="#{CRQueryView.selected.additionalDocs}" var="contractDoc" 
					reflow="true" style="margin-bottom:20px;border-collapse:collapse"
					scrollable="true" scrollHeight="100%" >

					<f:facet name="header">
 						<p:outputPanel style="height:30px">
 							<p:commandButton id="toggler" type="button" value="Columns" style="float:right" icon="ui-icon-calculator" />
							<p:columnToggler datasource="additionalDocs1" trigger="toggler" style="width:200px"/>
 						
 							<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
								<!-- Este boton solo se muestra cuando la CapRequest est en estado SUBMITTED o ACCEPTED. La Capacity Request a evaluar sera la guardada en selected. -->
   					       		<p:commandButton value="#{msg['cr_man_add_doc']}" icon="ui-icon-plus" style="float:right;"
									actionListener="#{CRQueryView.createNewDocFile}" update=":form:msgs,#{p:component('addDocFormId')}"
									onstart="PF('cargando').show()"	oncomplete="PF('cargando').hide();PF('addDocDlg').show()"
									rendered="#{CRQueryView.selected.status=='SUBMITTED' or CRQueryView.selected.status=='ACCEPTED' or CRQueryView.selected.status=='COMPLETED'}" />
									<!-- No es necesario pasar parametro a la ventana de añadir, porque ya se relleno selected previamente. -->	    									
 							</shiro:hasPermission>
 						</p:outputPanel>       										          
			        </f:facet>


			       	<p:column headerText="#{msg['cr_man_file_name']}" style="width: 60px;" sortBy="#{contractDoc.fileName}">
 					    <p:commandButton ajax="false" actionListener="#{CRQueryView.getDocFile(contractDoc)}" 
					    	oncomplete="PrimeFaces.monitorDownload(start, stop);" icon="ui-icon fa fa-save" title="#{contractDoc.fileName}" >
					        <p:fileDownload value="#{contractDoc.scFile}"/>
					    </p:commandButton>
					    <p:spacer width="10"/>
						<h:outputText value="#{contractDoc.fileName}" title="#{contractDoc.fileName}" />
			       	</p:column>

			       	<p:column headerText="#{msg['cr_man_submitted_timestamp']}" style="width: 55px; text-align: center;" sortBy="#{contractDoc.submissionDate}" >
	               		<h:outputText value="#{contractDoc.submissionDate}" >
	              				<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
	              		</h:outputText>
			       	</p:column>
					       
			       	<p:column headerText="#{msg['cr_man_doc_type']}" style="width: 40px; text-align: center;" sortBy="#{contractDoc.docTypeCode}">
 						<h:outputText value="#{CRQueryView.getDocTypeExternalCode(contractDoc.contractAttachTypeId)}" title="#{CRQueryView.getDocTypeExternalCode(contractDoc.contractAttachTypeId)}" />				
			       	</p:column>

			       	<p:column headerText="#{msg['cr_man_comments_remarks']}" style="width: 100px; text-align: center;" >
 						<h:outputText value="#{contractDoc.comments}" title="#{contractDoc.comments}" style="float:left" />				
			       	</p:column>

					<!-- Esta columna solo se muestra cuando la CapRequest est en estado SUBMITTED o ACCEPTED. La Capacity Request a evaluar sera la guardada en selected. -->
 					<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
						<p:column headerText="#{msg['cr_man_delete_file']}" style="width: 10px; text-align: center;"
							rendered="#{CRQueryView.selected.status=='SUBMITTED' or CRQueryView.selected.status=='ACCEPTED' or CRQueryView.selected.status=='COMPLETED'}">
	  						<p:commandButton actionListener="#{CRQueryView.onConditionalDeleteDocFile(contractDoc)}" 
						    	icon="ui-icon-trash" title="#{msg['cr_man_delete_file']}" />
				       	</p:column>
 					</shiro:hasPermission>
				</p:dataTable>
			</h:form>
		</p:dialog>	

 	<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
		<!-- Si no se usa appendTo="@(body)", la ventana modal bloquea toda la interfaz. -->
 		<p:dialog header="#{msg['cr_man_confirmation_dialog_header']}" widgetVar="w_confirmDeleteDocDlg" id="confirmDeleteDocDlg" 
			modal="true" appendTo="@(body)" minHeight="250" >
			<h:form id="confirmDeleteDocFormId" style="width:100%;height:98%;border-collapse:collapse">
				<p:panelGrid id="confirmDeleteDocPanelGridId" columns="2">

					<p:row>
						<p:column  style="font-weight: bold;">
							<h:outputText value="#{msg['cr_man_delete_file_confirm']}" />
						</p:column>
					</p:row>

 					<p:row>
						<p:column  style="font-weight: bold;">
				       		<p:commandButton value="#{msg['yes']}"
				       			actionListener="#{CRQueryView.deleteDocFile}" 
				       			update="#{p:component('additionalDocs1')},#{p:component('msgs')}"
								onstart="PF('grabando').show()" 
								oncomplete="PF('grabando').hide();PF('w_confirmDeleteDocDlg').hide()" />						
						</p:column>
						<p:column  style="font-weight: bold;">
				       		<p:commandButton value="#{msg['no']}"
				       			oncomplete="PF('w_confirmDeleteDocDlg').hide()"/>
						</p:column>
					</p:row>
				</p:panelGrid>
			</h:form> 	    
		</p:dialog>
 	</shiro:hasPermission>

 	<shiro:hasPermission name="#{changeSystemView.system}.BOOKING.CR_QUERY.MOD">
		<p:dialog header="#{msg['cr_man_add_doc']}" widgetVar="addDocDlg" modal="true" appendTo="@(body)" height="250" width="620">
			<h:form id="addDocFormId" style="width:100%;height:98%;border-collapse:collapse">
				<p:panelGrid id="addDocPanelGridId" >
					
					<p:row>
				     	<p:column style="width: 170px;">
				       		<h:outputText value="#{msg['cr_man_choose_doc_type']}" />
				       	</p:column>	
				       	<p:column >
				       		<h:outputText value="#{msg['cr_man_choose_file_upload']}" />
				       	</p:column>
					</p:row>
					<p:row>
				       	<p:column style="width: 170px;">
 							<p:selectOneMenu id="newDocTypeCode" style="width:50px" value="#{CRQueryView.newDocument.contractAttachTypeId}" >
								<!-- Con el boton de FileUpload no se actualiza este campo de newDocument. Hay que actualizarlo con ajax. -->
								<p:ajax event="change" update="newDocTypeCode" />
 								<f:selectItems value="#{CRQueryView.getDocTypesList()}" var="docType" 
									itemValue="#{docType.contractAttachTypeId}" itemLabel="#{CRQueryView.getDocTypeExternalCode(docType.contractAttachTypeId)}" />
			           		</p:selectOneMenu>
				       	</p:column>	
				       	<p:column >
				       		<!-- No se limita el tipo de fichero ni el tamaño. -->
							<p:fileUpload id="docUpload" style="width:100%" fileUploadListener="#{CRQueryView.handleDocFileUpload}" 
								mode="advanced" dragDropSupport="true" fileLimit="1" ajax="true" update=":form:msgs,:addDocFormId,:#{p:component('additionalDocs1')}"
		     					onstart="PF('cargando').show()" oncomplete="PF('cargando').hide();PF('addDocDlg').hide()"/>
				       	</p:column>
					</p:row>
					
					<p:row>
						<p:column colspan="2">
				       	<h:outputText value="#{msg['cr_man_write_comment']}" />
						</p:column>
					</p:row>
					<p:row>
						<p:column colspan="2">
						<p:inputTextarea id="newDocComments" value="#{CRQueryView.newDocument.comments}" 
							counter="display" maxlength="250" counterTemplate="#{msg['cr_man_char_remaining']}"
							cols="75" >
							<!-- Con el boton de FileUpload no se actualiza este campo de newDocument. Hay que actualizarlo con ajax. -->
							<p:ajax event="change" update="newDocComments" />
						</p:inputTextarea>
						</p:column>
					</p:row>
					<p:row>
						<p:column colspan="2">
						<h:outputText id="display" />
						</p:column>
					</p:row>
					
				</p:panelGrid> 				
			</h:form> 
		</p:dialog>
 	</shiro:hasPermission>

		<p:dialog header="#{msg['cr_man_rejected_points']}" widgetVar="rejectPointsDlg" modal="true" appendTo="@(body)" height="200">
			<h:form id="rejPointsFormId" style="width:100%;height:98%;border-collapse:collapse">
				<p:dataGrid value="#{CRQueryView.selected.rejectedPointCodes}" var="pointCode"  columns="1">
				    <h:outputText value="#{pointCode}"/>
      			</p:dataGrid>
			</h:form> 
		</p:dialog>	
		
		<p:dialog header="#{msg['cr_man_management_comments']}" widgetVar="managementCommentsDlg" modal="true" appendTo="@(body)" height="200" width="800">
			<h:form id="manCommentsFormId" style="width:100%;height:98%;border-collapse:collapse">
 				<h:inputTextarea value="#{CRQueryView.selected.managementComments}" readonly="true" rows="12" cols="105" style="border-color: white"/>
			</h:form> 
		</p:dialog>				
	</ui:define>
	
	<script type="text/javascript">
	function start() {
	    PF('cargando').show();
	}
	 
	function stop() {
	    PF('cargando').hide();
	}
	</script>
</ui:composition>