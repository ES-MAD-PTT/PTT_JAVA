<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.atos.mapper.dam.NominationConceptMapper">

<resultMap id="NominationConcept" type="com.atos.beans.dam.NominationConceptBean">

<result column="concept_code" property="id"/>

<result column="type_desc" property="name"/>

</resultMap>

<select id="selectNominationConcept" resultMap="NominationConcept">SELECT a.concept_code,b.type_desc 
FROM tpa_tnomination_concept a,tpa_tnom_concept_type b,tpa_tnom_concept_system c 
WHERE a.idn_nom_concept_type = b.idn_nom_concept_type 
AND b.type_code NOT IN ('COMMERCIAL', 'ALLOCATION_ONLY') 
AND a.is_enabled = 'Y'
AND c.idn_pipeline_system = #{idn_system}
AND a.idn_nomination_concept = c.idn_nomination_concept 
<if test="nomConcept != null and nomConcept != ''">
	and a.idn_nomination_concept = #{nomConcept}
</if>
<if test="nomConceptType != null and nomConceptType != ''">
	and a.idn_nom_concept_type = #{nomConceptType}
</if>
</select> 

 <select id="selectNominationConceptCombo" parameterType="java.math.BigDecimal" resultType="com.atos.beans.ComboFilterNS">
		select n.idn_nomination_concept as key, n.concept_code as value 
		from tpa_tnomination_concept n, tpa_tnom_concept_system c  
		where n.idn_nom_concept_type not in (select t.idn_nom_concept_type from tpa_tnom_concept_type t where t.type_code in ('COMMERCIAL', 'ALLOCATION_ONLY'))
        and c.idn_nomination_concept = n.idn_nomination_concept
        and n.is_enabled = 'Y'
		and c.idn_pipeline_system = #{idn_system}
		order by 2
    </select>
    
    <select id="selectNominationConceptTypeCombo" parameterType="java.math.BigDecimal" resultType="com.atos.beans.ComboFilterNS">
		select n.idn_nom_concept_type as key, n.type_desc as value
        from tpa_tnom_concept_type n
        where n.type_code not in ('COMMERCIAL', 'ALLOCATION_ONLY')
        order by 2
    </select>
    
    <select id="selectNominationConceptComboUnitType" resultType="com.atos.beans.ComboFilterNS">
		select idn_unit_type as key, type_desc as value from tpa_tunit_type
    </select>
    
    <select id="getCountNominationConcept" resultType="java.lang.Integer">
	    SELECT COUNT(*)		
  FROM (		
        SELECT p.point_code		
          FROM tpa_tsystem_point p		
         WHERE p.point_code = #{nomConcept}		
        UNION		
        SELECT c.concept_code		
          FROM tpa_tnomination_concept c		
         WHERE c.concept_code = #{nomConcept})	    
	</select>
	<insert id="insertNomConcep" useGeneratedKeys="true" keyProperty="idn_nom_concept_system" keyColumn="idn_nom_concept_system" parameterType="com.atos.filters.dam.NominationConceptFilter">
		INSERT INTO tpa_tnom_concept_system(idn_nom_concept_system,					
                                    idn_nomination_concept,							
                                    idn_pipeline_system,							
                                    start_date,							
                                    end_date,							
                                    aud_ins_date,							
                                    aud_last_date,							
                                    aud_ins_user,							
                                    aud_last_user)							
			  VALUES(tpa_snom_concept_system.nextval,							
			          (SELECT idn_nomination_concept FROM tpa_tnomination_concept WHERE concept_code = #{nomConcept}),							
			          #{idn_system},							
			          TRUNC(SYSDATE-1),							
			          NULL,							
			          SYSDATE,							
			          SYSDATE,							
			          #{user},							
			          #{user})
	</insert>
	
	
	
	<insert id="insertNomConcept" useGeneratedKeys="true" keyProperty="idn_nom_concept_system" keyColumn="idn_nom_concept_system" parameterType="com.atos.filters.dam.NominationConceptFilter">
INSERT
	INTO tpa_tnomination_concept (idn_nomination_concept,
	concept_code,
	concept_desc,
	idn_nom_concept_type,
	idn_unit_type,
	sort_value,
	is_point_concept,
	is_area_concept,
	is_zone_concept,
	is_enabled,
	is_calculated,
	allow_negative,
	aud_ins_date,
	aud_last_date,
	aud_ins_user,
	aud_last_user)
VALUES (tpa_snomination_concept.nextval,
#{nomConcept},
#{nomConcept},
#{unitType},
#{unitType},
999999,
'N',
#{is_area_concept},
#{is_zone_concept},
'Y',
'N',
'Y',
SYSDATE,
SYSDATE,
#{user},
#{user}))
	</insert>
    

</mapper>