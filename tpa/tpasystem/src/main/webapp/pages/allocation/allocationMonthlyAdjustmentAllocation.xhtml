<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:shiro="http://shiro.apache.org/tags"
	xmlns:atos="http://java.sun.com/jsf/composite/atos"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:f="http://java.sun.com/jsf/core"
	template="/templates/template.xhtml">
	<ui:define name="metadata">
	</ui:define>
	<ui:define name="breadCrumbComponent">
		<p:breadCrumb id="path_page" style="margin-bottom:3px">
			<p:menuitem value="#{msg['menu_home']}" icon="ui-icon fa fa-home"
				style="bottom: -3px;left: 3px" url="/home.xhtml" />
			<p:menuitem value="#{msg['menu_allocation']}" url="#" />
			<p:menuitem value="#{msg['menu_monthly_adjustment_allocation']}"
				url="/pages/allocation/allocationMonthlyAdjustmentAllocation.xhtml" />
		</p:breadCrumb>
	</ui:define>
	<ui:define name="content">
<style>
.ui-datepicker{ z-index: 9999 !important;}
.atos-cal{
width:110px
}
</style>
		<h:form id="form"
			style="width:100%;height:98%;border-collapse:collapse"
			fullPage="true">
			<p:growl id="msgs" showDetail="true" life="10000" />

			<p:layout widgetVar="AllocationAdjustLayout"
				style="width:100%;height:100%" showEffect="clip" hideEffect="clip">

				<p:layoutUnit position="north" resizable="false" closable="false"
					collapsible="true" id="page_filters">

					<p:panelGrid columns="2" style="width:100%">

						<p:panelGrid>

							<p:row>

								<p:column style="font-weight: bold;width:70px">

									<h:outputText value="#{msg['res_bal_start_date']}" />
								</p:column>

								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['res_bal_end_date']}" />
								</p:column>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['all_rev_shipper_code']}" />
								</p:column>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['all_rev_contract_code']}" />
								</p:column>

								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['all_rev_status']}" />
								</p:column>

								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['alloc_adjust_adjust_code']}" />
								</p:column>


							</p:row>

							<p:row>
								<p:column>
									<atos:calendarMonthYear calId="fromDate" styleClass="atos-cal"
										calValue="#{allocMonth.filter.startDate}">
										<f:ajax event="calChangeEvent" execute="@form" render="@form" />
									</atos:calendarMonthYear>
								</p:column>
								<p:column style="width:70px">
									<atos:calendarMonthYear calId="toDate" styleClass="atos-cal"
										calValue="#{allocMonth.filter.enDate}">

										<f:ajax event="calChangeEvent" execute="@form" render="@form" />
									</atos:calendarMonthYear>
								</p:column>
								<p:column>
									<p:selectOneMenu id="shipperId" autoWidth="false" 
										style="width:85px" value="#{allocMonth.filter.shipperId}"
										rendered="#{not allocMonth.shipper}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.shipperIds.entrySet()}"
											var="entry" itemValue="#{entry.key}"
											itemLabel="#{entry.value}" />
										<p:ajax event="change" update="contractId" />
									</p:selectOneMenu>
									<h:outputText value="#{allocMonth.shipperName}" rendered="#{allocMonth.shipper}"/>
									<p:outputLabel value="#{allocMonth.filter.shipperId}"
										rendered="#{allocMonth.shipper}" />
								</p:column>
								<p:column>
									<p:selectOneMenu id="contractId" autoWidth="false"
										style="width:140px" value="#{allocMonth.filter.contractId}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.contractIds}" var="entry"
											itemValue="#{entry.idn_contract}"
											itemLabel="#{entry.contract_code}" />
									</p:selectOneMenu>
								</p:column>

								<p:column>
									<p:selectCheckboxMenu id="status" autoWidth="false"
										style="width:100px" value="#{allocMonth.filter.statusCode}"
										label="#{msg['all_rev_status']}">
										<f:selectItem itemLabel="#{msg['all_rev_accepted']}"
											itemValue="ACCEPTED" />
										<f:selectItem itemLabel="#{msg['all_rev_allocated']}"
											itemValue="ALLOCATED" />
									</p:selectCheckboxMenu>
								</p:column>
								<p:column>
									<p:inputText id="adjustCode" style="width:130px"
										value="#{allocMonth.filter.adjustmentCode}" />
								</p:column>
							</p:row>

						</p:panelGrid>

						<p:panelGrid columns="2" style="float:right;top:0px">

							<shiro:hasPermission
								name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.QUERY">
								<p:commandButton value="#{msg['search']}"
									icon="ui-icon fa fa-search"
									actionListener="#{allocMonth.onSearch}"
									onstart="PF('cargando').show()"
									oncomplete="PF('cargando').hide()" 
									update="msgs,:#{p:component('allocations1')}" />
							</shiro:hasPermission>
								<p:commandButton  onclick="PF('AllocationAdjustLayout').toggle('north')" id="header_collapse" icon="fa fa-minus" value="#{msg['minimize']}" title="#{msg['collapse_header']}" />

							<shiro:hasPermission
								name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.QUERY">
								<p:commandButton value="#{msg['clear']}"
									actionListener="#{allocMonth.onClear}"
									onstart="PF('limpiando').show()"
									oncomplete="PF('limpiando').hide()" process="@this"
									update="msgs,@form" />
							</shiro:hasPermission>

							<shiro:hasPermission
								name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.RUN">
								<p:commandButton id="executeButton" type="button"
									value="#{msg['all_man_execute']}" style="float:left;"
									icon="ui-icon fa fa-gears" onclick="PF('dlgExecute').show();" />
							</shiro:hasPermission>


						</p:panelGrid>
					</p:panelGrid>
				</p:layoutUnit>

				<p:layoutUnit id="table_center_layout" position="center"
					resizable="false" closable="false" collapsible="false"
					style="border: 0;">

					<p:dataTable widgetVar="w_allocations1" id="allocations1"
						var="item" value="#{allocMonth.resultList}" reflow="true"
						editable="true"
						style="margin-bottom:20px;border-collapse:collapse"
						scrollable="true" scrollHeight="100%"  paginator="true" rows="15"
						rowsPerPageTemplate="5,10,15,20,25">
							<f:facet name="header">
								<p:outputPanel style="height:25px">

							<shiro:hasPermission
								name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.ADD">
								<p:commandButton id="newButton" type="button"
									value="#{msg['res_bal_new']}" style="float:right;"
									onclick="PF('w_newAdjustDlg').show();$('.ui-datepicker-close').click()" />
							</shiro:hasPermission>
								</p:outputPanel>
								</f:facet>

						<shiro:hasPermission
							name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.QUERY">

					       <p:column headerText="#{msg['all_rev_gas_day']}" style="width:70px">
			               		<h:outputText value="#{item.gasDay}" >
			              				<f:convertDateTime pattern="dd/MM/yyyy" />
			              		</h:outputText>
					       </p:column>

					       <p:column headerText="#{msg['alloc_adjust_origin_shipper']}">
					       		<h:outputText value ="#{item.originShipper}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_origin_contract']}">
					       		<h:outputText value ="#{item.originContract}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_origin_zone']}" style="width:65px">
					       		<h:outputText value ="#{item.originZone}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_origin_value']}">
					       		<h:outputText value ="#{item.originValue}" style="float:right"/>
					       </p:column>
					       
					       
					       <p:column headerText="#{msg['alloc_adjust_destination_shipper']}">
					       		<h:outputText value ="#{item.destinationShipper}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_destination_contract']}">
					       		<h:outputText value ="#{item.destinationContract}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_destination_zone']}" style="width:65px">
					       		<h:outputText value ="#{item.destinationZone}"/>
					       </p:column>
					       <p:column headerText="#{msg['alloc_adjust_destination_value']}">
					       		<h:outputText value ="#{item.destinationValue}" style="float:right"/>
					       </p:column>
					       
					       <p:column headerText="#{msg['alloc_adjust_status']}" style="width:70px">
					       		<h:outputText value ="#{item.status}"/>
					       </p:column>
					       
					       <p:column headerText="#{msg['alloc_adjust_review_code']}">
					       		<h:outputText value ="#{item.reviewCode}"/>
					       </p:column>

						</shiro:hasPermission>
					</p:dataTable>
				</p:layoutUnit>
			</p:layout>
		</h:form>

		<p:dialog header="#{msg['alloc_adjust_new']}"
			widgetVar="w_newAdjustDlg" id="newAdjustDlg" modal="true"
			appendTo="@(body)" minHeight="250">
			<h:form id="confirmAcceptFormId"
				style="width:100%;height:98%;border-collapse:collapse">

				<p:panelGrid columns="2" >
					
					<h:outputText value="#{msg['res_bal_month']}" style="padding-left:10px"/>

					<atos:calendarMonthYear calId="afford"
										calValue="#{allocMonth.newAdjust.monthYear}" >

										<f:ajax event="calChangeEvent" execute="@form" render="@form newcontractId" listener="#{allocMonth.onChangeNewContractDate}" />
										</atos:calendarMonthYear>

					<!-- origin -->
					<p:panelGrid columns="2" id="origPanel">

									<h:outputText value="#{msg['alloc_adjust_origin_shipper']}" />
									<p:selectOneMenu widgetVar="w_newshipperId" id="newshipperId" autoWidth="false"
										style="width:85px" value="#{allocMonth.newAdjust.origShipperId}"
										rendered="#{not allocMonth.shipper}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.shipperIds.entrySet()}"
											var="entry" itemValue="#{entry.key}"
											itemLabel="#{entry.value}" />
										<p:ajax event="change" update="newcontractId newdestcontractId" />
									</p:selectOneMenu>
									<h:outputText value="#{allocMonth.shipperName}" rendered="#{allocMonth.shipper}"/>
									<h:outputText value="#{msg['alloc_adjust_origin_contract']}" />
									<p:selectOneMenu id="newcontractId" autoWidth="false"
										style="width:130px" value="#{allocMonth.newAdjust.origContractId}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.originContractIds}" var="entry"
											itemValue="#{entry.idn_contract}"
											itemLabel="#{entry.contract_code}" />
											<p:ajax event="change" update="@this originZone newdestcontractId"/>
									</p:selectOneMenu>
									<h:outputText value="#{msg['alloc_adjust_origin_zone']}" />
									<p:selectOneMenu id="originZone" autoWidth="false" style="width:100px" value="#{allocMonth.newAdjust.origZone}" >
								   		<f:selectItem itemLabel="" itemValue="" />
      									<f:selectItems value="#{allocMonth.zoneIds.entrySet()}" var="entry" 
      										itemValue="#{entry.key}" itemLabel="#{entry.value}" />
					           		</p:selectOneMenu>						
					</p:panelGrid>
					<!-- destination -->
					<p:panelGrid columns="2">

									<h:outputText value="#{msg['alloc_adjust_destination_shipper']}" />
									<p:selectOneMenu id="newdestshipperId" autoWidth="false"
										style="width:85px" value="#{allocMonth.newAdjust.destShipperId}"
										rendered="#{not allocMonth.shipper}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.shipperIds.entrySet()}"
											var="entry" itemValue="#{entry.key}"
											itemLabel="#{entry.value}" />
										<p:ajax event="change" update="newdestcontractId" />
									</p:selectOneMenu>
									<h:outputText value="#{allocMonth.shipperName}" rendered="#{allocMonth.shipper}"/>
									<h:outputText value="#{msg['alloc_adjust_destination_contract']}" />
									<p:selectOneMenu id="newdestcontractId" autoWidth="false"
										style="width:130px" value="#{allocMonth.newAdjust.destContractId}">
										<f:selectItem itemLabel="" itemValue="" />
										<f:selectItems value="#{allocMonth.destContractIds}" var="entry"
											itemValue="#{entry.idn_contract}"
											itemLabel="#{entry.contract_code}" />
											<p:ajax event="valueChange" update="@this destZone gday" listener="#{allocMonth.onChangeDestContract}"/>
									</p:selectOneMenu>

									<h:outputText value="#{msg['alloc_adjust_destination_zone']}" />
									<p:selectOneMenu id="destZone" autoWidth="false" style="width:100px" value="#{allocMonth.newAdjust.destZone}" >
								   		<f:selectItem itemLabel="" itemValue="" />
      									<f:selectItems value="#{allocMonth.zoneIdsDest.entrySet()}" var="entry" 
      										itemValue="#{entry.key}" itemLabel="#{entry.value}" />
					           		</p:selectOneMenu>						
					</p:panelGrid>

					<h:outputText value="#{msg['alloc_adjust_value']}" style="padding-left:10px"/>
				  						<p:inputNumber value="#{allocMonth.newAdjust.adjustValue}" minValue="0" decimalPlaces="4" thousandSeparator="," 
											decimalSeparator="." emptyValue="empty" />
					<h:outputText value="#{msg['gas_day']}" style="padding-left:10px"/>
					<h:outputText id="gday" value="#{allocMonth.newAdjust.gasDay}" style="padding-left:10px">
						
			              				<f:convertDateTime pattern="dd/MM/yyyy" locale="en"/>
					</h:outputText>
					<h:outputText value="#{msg['alloc_adjust_comments']}" style="padding-left:10px"/>
					<p:inputTextarea maxlength="120" cols="50" value="#{allocMonth.newAdjust.operatorComments}"/>

									<p:commandButton value="#{msg['save']}" style="float:right;"
										actionListener="#{allocMonth.onSave}"
										update="#{p:component('msgs')}"
										onstart="PF('grabando').show()"
										oncomplete="PF('grabando').hide();PF('w_newAdjustDlg').hide();" />
									<p:commandButton value="#{msg['cancel']}"
										oncomplete="PF('w_newAdjustDlg').hide()" />
				</p:panelGrid>
			</h:form>
		</p:dialog>


		<shiro:hasPermission
			name="#{changeSystemView.system}.ALLOCATION.MONTHLY_ADJUSTMENT.RUN">
			<!-- Si no se usa appendTo="@(body)", la ventana modal bloquea toda la interfaz. -->
			<p:dialog header="#{msg['all_man_execution_dialog_header']}"
				widgetVar="dlgExecute" modal="true" appendTo="@(body)"
				minHeight="150" width="350">
				<h:form id="executeFormId"
					style="width:100%;height:98%;border-collapse:collapse">

					<p:growl id="msgs" showDetail="true" life="10000" globalOnly="true" />
					<p:panelGrid id="executePanelGridId">
						<p:panelGrid id="executePanelGridLeftId">
							<p:row>
								<p:column colspan="2">
									<h:outputText value="#{msg['all_man_execution_intro']}" />
								</p:column>
							</p:row>
							<p:row>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['all_man_from']}" />
								</p:column>
								<p:column>
									<h:outputText value="#{allocMonth.responsePeriodStartDate}">
										<f:convertDateTime pattern="dd/MM/yyyy" />
									</h:outputText>
								</p:column>
							</p:row>
							<p:row>
								<p:column style="font-weight: bold;">
									<h:outputText value="#{msg['all_man_to']}" />
								</p:column>
								<p:column>
									<h:outputText value="#{allocMonth.responsePeriodEndDate}">
										<f:convertDateTime pattern="dd/MM/yyyy" />
									</h:outputText>
								</p:column>
							</p:row>
							<p:row>
								<p:column />
								<p:column />
							</p:row>
							<p:row>
								<p:column />
								<p:column />
							</p:row>
							<p:row>
								<p:column style="font-weight: bold;">
									<p:commandButton value="#{msg['execute']}" style="float:right;"
										actionListener="#{allocMonth.onExecute}"
										update="#{p:component('msgs')}"
										onstart="PF('grabando').show()"
										oncomplete="PF('grabando').hide();PF('dlgExecute').hide()" />
								</p:column>
								<p:column style="font-weight: bold;">
									<p:commandButton value="#{msg['cancel']}"
										oncomplete="PF('dlgExecute').hide()" />
								</p:column>
							</p:row>
						</p:panelGrid>
					</p:panelGrid>
				</h:form>
			</p:dialog>
		</shiro:hasPermission>
	</ui:define>

	<script type="text/javascript">
		function start() {
			PF('cargando').show();
		}

		function stop() {
			PF('cargando').hide();
		}
	</script>
</ui:composition>